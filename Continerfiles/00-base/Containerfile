FROM alpine:3.16 as installer

ARG USER=sentinelos
ARG USER_ID=1001
ARG GROUP=sentinelos
ARG GROUP_ID=1001
ARG WORKDIR=/app
ARG VERSION=

# Install packages
RUN apk update && apk add --no-cache \
    --repository https://dl-cdn.alpinelinux.org/alpine/3.16/main \
    --repository https://dl-cdn.alpinelinux.org/alpine/3.16/community \
    --repository https://dl-cdn.alpinelinux.org/alpine/3.16/testing \
    bash \
    bash-completion \
    bind-tools \
    ca-certificates \
    curl \
    git \
    gzip \
    htop \
    jq \
    libc6-compat \
    micro \
    nano \
    openssh-client \
    sudo \
    tar \
    tree \
    tzdata

# Create a group and user
RUN addgroup -g $GROUP_ID -S $GROUP \
	&& adduser \
	--disabled-password \
	-g $GROUP_ID \
	-D \
    -S \
	-s "/bin/bash" \
	-h "/home/$USER" \
	-u $USER_ID \
	-G $GROUP $USER \
	&& mkdir -p $WORKDIR \
	&& chown -R $USER:$GROUP $WORKDIR

COPY overlay /

RUN sed -i "s/{{VERSION}}/${VERSION}/" /etc/os-release \
    && rm -rf \
    /var/cache/apk/*

FROM scratch as final

ARG ARCH=amd64
ARG VERSION=
ARG WORKDIR=/app

LABEL org.opencontainers.image.authors="Sentinel OS Authors"
LABEL org.opencontainers.image.title="Sentinel OS"
LABEL org.opencontainers.image.description="Sentinel OS Base Image"
LABEL org.opencontainers.image.arch="${ARCH}"
LABEL org.opencontainers.image.version="${VERSION}"
LABEL org.opencontainers.image.source="https://github.com/sentinelos/base"
LABEL org.opencontainers.image.licenses="MPL-2.0"

ENV PS1="\@ \u@\h \w$ "
ENV EDITOR="nano"

WORKDIR $WORKDIR

COPY --from=installer /  /

CMD ["bash"]
